<!DOCTYPE html>
<html>
<head>
<title>Tanks</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
    overflow-x: hidden;
    overflow-y: hidden;
}

</style>
</head>
<canvas id='gamearea'></canvas>
<body onload="startGame()">
<img id="red" src="{{url_for('static', filename='Untitled.png')}}" width="220" height="277" hidden>
<img id="blue" src="{{url_for('static', filename='outline.png')}}" width="220" height="277" hidden>

<img id="bulletimg" src="{{url_for('static', filename='dart.png')}}" width="220" height="277" hidden>

<script>

function Point(x,y){ 
	this.x = x;
	this.y = y;
}
function formula(P,Q){
  
    x = Q.y - P.y;
    y = P.x - Q.x; 
    b = x*(P.x) + y*(P.y);
    y = -y;
    b = -b;
    x = x/y;
    b = b/y;
    return [x,b];
  
    
}

function onSegment(p, q, r){
	if (( (q.x <= Math.max(p.x, r.x)) && (q.x >= Math.min(p.x, r.x)) && (q.y <= Math.max(p.y, r.y)) && (q.y >= Math.min(p.y, r.y)))){
        return true;
    }
	return false;
}
function orientation(p, q, r){
	val = ((q.y - p.y) * (r.x - q.x)) - ((q.x - p.x) * (r.y - q.y));
	if (val > 0){
		return 1
    }else if (val < 0){
        return 2
    }else{
        return 0
    }
}
function doIntersect(p1,q1,p2,q2){
	o1 = orientation(p1, q1, p2);
	o2 = orientation(p1, q1, q2);
	o3 = orientation(p2, q2, p1);
	o4 = orientation(p2, q2, q1);
	if (((o1 != o2) && (o3 != o4))){
        return true
    } 
	if (((o1 == 0) && onSegment(p1, p2, q1))){
		return true
    }

	if (((o2 == 0) && onSegment(p1, q2, q1))){
		return true
    } 
	if (((o3 == 0) && onSegment(p2, p1, q2))){
        return true
    } 
	if (((o4 == 0) && onSegment(p2, q1, q2))){
        return true
    }
	return false
}

function GetPointRotated(X, Y, W, H, R, Xos, Yos){
	var rotatedX = X + (Xos  * Math.cos(R)) - (Yos * Math.sin(R));
	var rotatedY = Y + (Xos  * Math.sin(R)) + (Yos * Math.cos(R));
    coords = new Point(rotatedX,rotatedY);
	return coords;
}
function difference(a, b) {
  return Math.abs(a - b);
}
function findcorners(xpos, ypos, angle, width, height) {
    corner1 = GetPointRotated(xpos, ypos, width, height, angle, width/2, height/2);
    corner2 = GetPointRotated(xpos, ypos, width, height, angle, -width/2, height/2);
    corner3 = GetPointRotated(xpos, ypos, width, height, angle, width/2, -height/2);
    corner4 = GetPointRotated(xpos, ypos, width, height, angle, -width/2, -height/2);
    return [corner1,corner2,corner4,corner3];
}


function startGame() {
    redtank = new maketank(100, 100,225, 225, "red");
    bluetank= new maketank(100, 100, 500, 225, "blue");
    wiper = new maketank(0,0,0,0, "wiper");
    tanks = [redtank, bluetank, wiper];
    bullets = [];
    frictioncollision = document.getElementById("frictioncollision").checked;
    gamearea.start();
}

var gamearea = {
    canvas : document.getElementById("gamearea"),
    start : function() {
        this.canvas.width = screen.width * 0.9;
        this.canvas.height = screen.height * 0.75;
        this.context = this.canvas.getContext("2d");
        
        this.interval = setInterval(updateGameArea, 1);
        window.addEventListener('keydown', function (e) {
            e.preventDefault();
            gamearea.keys = (gamearea.keys || []);
            gamearea.keys[e.keyCode] = (e.type == "keydown");
        })
        window.addEventListener('keyup', function (e) {
            gamearea.keys[e.keyCode] = (e.type == "keydown");
        })
    },
    stop : function() {
        clearInterval(this.interval);
    },    
    clear : function() {
        ctx = this.context;
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0,0, this.canvas.width*5, this.canvas.height*5);

    }
}
function bullet(width, height, x, y, angle, speed, index) {
    this.index = index;
    this.width = width;
    this.height = height;
    this.x=x;
    this.y=y;
    this.angle=angle;
    this.speed=speed;
    this.x += this.height/2 * Math.sin(this.angle);
    this.y -= this.height/2 * Math.cos(this.angle);
    this.update = function() {
        var ctx = gamearea.context;
        var bulletimg = document.getElementById('bulletimg');
        bulletimg.width=this.width;
        bulletimg.height=this.height;
        ctx.setTransform(1, 0, 0, 1, this.x, this.y); // sets scale && origin
        ctx.rotate(this.angle);
        ctx.drawImage(bulletimg, this.width / -2, this.height / -2, this.width, this.height);
        }
        
    this.newPos = function() {
        this.x += this.speed * Math.sin(this.angle);
        this.y -= this.speed * Math.cos(this.angle);  
    }
}

function maketank(width, height, x, y, colour) {
    this.width = width;
    this.colour = colour;
    this.height = height;
    this.speed = 0;
    this.angle = 0;
    this.moveAngle = 0;
    this.x = x;
    this.y = y;
    this.shoot = function() {
        newindex = bullets.length;
        append = new bullet(40,60,this.x,this.y,this.angle,4,newindex);
        bullets.push(append);
    }
    this.corners = function() {
        return findcorners(this.x,this.y,this.angle,this.width,this.height);
    }
    this.update = function() {
        var ctx = gamearea.context;
        if (this.colour == "wiper"){
            var tankimg = document.getElementById('red');
            tankimg.width=this.width;
            tankimg.height=this.height;
        }else{
            var tankimg = document.getElementById(this.colour);
            tankimg.width=this.width;
            tankimg.height=this.height;
        }
            ctx.setTransform(1, 0, 0, 1, this.x, this.y); // sets scale && origin
            ctx.rotate(this.angle);
            ctx.drawImage(tankimg, this.width / -2, this.height / -2, this.width, this.height);
        
        }
        
        
    this.othercorners = function(){
        /*  List structure for othercorners
            othercorners
                *the other tank besides this one*
                    Corner 1 [These 4 as Point() objects]
                    Corner 2
                    Corner 3
                    Corner 4 
                *this layer would have the other tanks if i added any*
        */
        tankslength = tanks.length;
        var i;
        var othercorners = [];
        for (i = 0; i < tankslength; i++) {
            if (this.colour != tanks[i].colour && tanks[i].colour != "wiper"){
                append = tanks[i].corners();
                othercorners.push(append);
            }
        }
        return othercorners;
    }
    this.newPos = function() {
        this.angle += this.moveAngle * Math.PI / 180;
        this.x += this.speed * Math.sin(this.angle);
        this.y -= this.speed * Math.cos(this.angle);
        var ourcorners = this.corners();
        var othercorners = this.othercorners();
        var i;
        var nexti;
        /* This for loop checks collision with other tanks*/
        
        /* for each diagonal on our tank...   */
        for (i = 0; i < ourcorners.length; i++) {
            var j;
            /* for each other tank  */
            for (j=0;j<othercorners.length;j++){
                var k;
                /* for each side on their tank */
                for (k=0;k<othercorners[j].length;k++){
                    if (k==3){
                        nextk = 0;
                    }else{
                        nextk=k+1;
                    }
                    if (i==3){
                        nexti=0;
                    }else{
                        nexti=i+1;
                    }
                    if (doIntersect(ourcorners[i],ourcorners[nexti],othercorners[j][k],othercorners[j][nextk])){
                        console.log('contact');
                        frictioncollision = document.getElementById("frictioncollision").checked;
                        if (frictioncollision){
                            this.angle -= this.moveAngle * Math.PI / 180;
                            this.x -= this.speed * Math.sin(this.angle);
                            this.y += this.speed * Math.cos(this.angle);
                        }else{
                            timeoutmax = 2 * this.speed;
                            if (this.speed==0){
                            }else{
                                if (this.speed<0){
                                    this.speed = -1;
                                }else{
                                    this.speed=1;
                                }
                            }
                            colliding = true;
                            xmove = this.speed * Math.sin(this.angle);
                            ymove = this.speed * Math.cos(this.angle);
                            timeout = 0;
                            while (colliding){
                                ourcorners = this.corners();
                                othercorners = this.othercorners();
                                this.x -= xmove;
                                this.y += ymove;
                                colliding = doIntersect(ourcorners[i],ourcorners[nexti],othercorners[j][k],othercorners[j][nextk]);
                                timeout++;
                                if (timeout>100){
                                    colliding = false;
                                }
                            }
                        }
                        
                    }
                }
            }
        }      
        /*
        Collision with walls at edge of map
        */
        var i;
        for (i = 0; i < ourcorners.length; i++) {
            if (ourcorners[i].x > gamearea.canvas.width){
                this.x = gamearea.canvas.width-(ourcorners[i].x-this.x);
            }
            if (ourcorners[i].x < 0) {
                this.x = this.x-ourcorners[i].x;
            }
            if (ourcorners[i].y > gamearea.canvas.height){
                this.y = gamearea.canvas.height-(ourcorners[i].y-this.y);
            }
            if (ourcorners[i].y < 0) {
                this.y = this.y-ourcorners[i].y;
            }
        }
        
        
    }
}



function updateGameArea() {
    gamearea.clear();
    redtank.moveAngle = 0;
    redtank.speed = 0;
    bluetank.moveAngle=0;
    bluetank.speed=0;
    if (gamearea.keys && gamearea.keys[37]) {bluetank.moveAngle = -2; }
    if (gamearea.keys && gamearea.keys[39]) {bluetank.moveAngle = 2; }
    if (gamearea.keys && gamearea.keys[38]) {bluetank.speed= 4;}
    if (gamearea.keys && gamearea.keys[40]) {bluetank.speed= -4; }
    if (gamearea.keys && gamearea.keys[16]) {bluetank.shoot(); }

    if (gamearea.keys && gamearea.keys[65]) {redtank.moveAngle = -1; }
    if (gamearea.keys && gamearea.keys[68]) {redtank.moveAngle = 1; }
    if (gamearea.keys && gamearea.keys[87]) {redtank.speed= 1;}
    if (gamearea.keys && gamearea.keys[83]) {redtank.speed= -1; }
    if (gamearea.keys && gamearea.keys[32]) {redtank.shoot(); }
    
    
    /*console.log(gamearea.keys);*/
    temp = bullets.length;
    var i;
    for (i = 0; i < temp; i++) {
        try{
            bullets[i].update();
            bullets[i].newPos();
        }
        catch(err) {
            bullets.splice(i,1);
        } 
    }
    temp = tanks.length;
    var i;
    for (i = 0; i < temp; i++) {
        
            if(tanks[i].colour != "wiper"){
                tanks[i].update();
                tanks[i].newPos();
            } else{
                tanks[i].update();
            }
            
        
    }
    var maxbullets = 500;
    bullets.splice(0, bullets.length-maxbullets);
}
</script>
<br>
<fieldset>
<p>Friction collision</p>
<input type="checkbox" id="frictioncollision">
</fieldset>
</body>
</html>